# 技術的な決定事項

## DB テーブル定義
### エリア テーブル

| 論理名 | 物理名 | データ型 | not nul 制約 | PRIMARY KEY 制約 | AUTOINCREMENT 属性 | 
| ---- | ---- | ---- | ---- | ---- | ---- |
| エリアID | id | integer | ◯ | ◯ |  ◯ | 
| エリア名 | name | varchar(2) | ◯ | |
| 登録日時 | created_at | datetime | ◯ | | |
| 更新日時 | updated_at | datetime | ◯ | | |

### 料金表 テーブル

| 論理名 | 物理名 | データ型 | not nul 制約 | PRIMARY KEY 制約 | AUTOINCREMENT 属性 | 
| ---- | ---- | ---- | ---- | ---- | ---- |
| 料金ID | id | integer | ◯ | ◯ | ◯ | |
| 料金プラン | plan | char(2) | ◯ |  |
| 登録日時 | created_at | datetime | ◯ | | |
| 更新日時 | updated_at | datetime | ◯ | | |

### ユーザ テーブル

| 論理名 | 物理名 | データ型 | not nul 制約 | ユニーク 制約 | 外部キー |
| ---- | ---- | ---- | ---- | ---- | ---- |
| ユーザID | id | integer | ◯ | ◯ |  |
| エリア | area | integer | ◯ |  | エリア テーブル.id |
| 料金表 | tariff | integer | ◯ | | 料金表 テーブル.id |
| 登録日時 | created_at | datetime | ◯ |  |
| 更新日時 | updated_at | datetime | ◯ |  |

### 消費データ テーブル

| 論理名 | 物理名 | データ型 | not nul 制約 | 外部キー | 
| ---- | ---- | ---- | ---- | ---- |
| ユーザID | user | integer | ◯ | ユーザ テーブル.id |
| 日時 | datetime | datetime | ◯ | |
| 消費量 | value | decimal(10, 2) | ◯ | |

#### 複合ユニークキーの設定
- 同じユーザ名に対して、ある日時のデータは、1件とするため、ユーザID / 日時 の２つを用いて、複合ユニークキーとする

## バリデーション

### ユーザデータ

| データ名 | エラー形式 | メッセージ |
| ---- | ---- | ---- |
| ユーザID | 未入力 | * This field is required. |
| ユーザID | 重複 | * User with this Id already exists. |
| エリア | 未入力 | * This field is required. |
| エリア | 不正値 (エリア テーブルに該当データがない) | * Select a valid choice. That choice is not one of the available choices. |
| 料金表 | 未入力 | * This field is required. |
| 料金表 | 不正値 (料金表 テーブルに該当データがない) | * Select a valid choice. That choice is not one of the available choices. |

### 消費データ

| データ名 | エラー形式 | メッセージ |
| ---- | ---- | ---- |
| 日時 | 未入力 | * This field is required. |
| 日時 | 形式 | * Consumption with this User and Datetime already exists. |
| 使用量 | 未入力 | * This field is required. |
| 使用量 | 形式 | * Ensure that there are no more than 8 digits before the decimal point. |

## 機能実装について

### エリア、料金表 の初期データについて

- テーブルに登録するための初期データについて、dashboard/consumption/init_datas.py に変数宣言しておく

- エリアデータ

```python
AREAS = [
    (1, 'a1'),
    (2, 'a2'),
]
```

- 料金表データ

```python
TARIFFS = [
    (1, 't1'),
    (2, 't2'),
    (3, 't3'),
]
```

- 以下の変数を、dashboard/consumption/config.py に宣言しておく


- ユーザデータパス

```
USER_DATA_FILE = ユーザデータファイルへのパス
```

- 消費データディレクトリへのパス

```
CONSUMPTION_DIR = 消費データディレクトリへのパス
```

- 加工済み消費データディレクトリへのパス

```
PREPROCESSED_CONSUMPTION_DIR = 消費データディレクトリへのパス
```

- テスト用の消費データディレクトリへのパス

```
TEST_CONSUMPTION_DIR = テスト用の消費データディレクトリへのパス
```

- テスト用の加工済み消費データディレクトリへのパス

```
TEST_PREPROCESSED_CONSUMPTION_DIR = テスト用の加工済み消費データディレクトリへのパス
```

### ユーザデータ / 消費量データの投入について

- 既存データの全削除
- 消費データの前処理を行う
    - 日時が重複したレコードの削除を行う
    - 30分間隔のデータで欠損があった場合、補完を行う
    - 加工したデータを、preprocessed_data/consumption に保存する
- ユーザデータのバリデーション
- 消費データのバリデーション
- ユーザデータの登録を行う
    - 全件バルクインサートを試みる
- 消費データの登録を行う
    - 各ファイルで、1000件単位でバルクインサートを試みる
- 前処理を行ったデータの削除

### サマリーページについて

- ユーザデータ / 消費量データの投入実装後、検討

### 詳細ページについて

- ユーザデータ / 消費量データの投入実装後、検討

## 使用言語 / ライブラリ
- Python
- Django
- isort
    - import の並べ替えのために使用
- flake8
    - コードのスタイルチェックのために使用
- Black
    - コードの自動的に整形のために使用
- Bandit
    - コードのセキュリティチェックのために使用
- データ分析ライブラリ
    - Pandas (https://pandas.pydata.org/)
        - CSVデータの内の重複を削除するために使用予定
        - データ投入時に
    - jupyter (https://jupyter.org/)
        - Pandasでのデータ前処理を検証するために使用

- CSS フレームワーク
    - BootStrap (https://getbootstrap.jp/)
    - CSS実装に使用予定

- Chart ライブラリ
    - Chart.js (https://www.chartjs.org/docs/latest/getting-started/)
    - グラフ生成に使用予定


# トレードオフ
## ユーザデータ / 消費量データの投入について

- 採用 : データのバリデーション/投入を分離する
    - はじめに、すべてのデータのバリデーションを行う
        - ユーザID・日時の重複チェックは、テーブルへの登録時のユニーク制限に任せる
    - すべてのファイルのバリデーションが通れば、登録処理を行う
    - メリット
        - バリデーション と 登録ロジックを分割できる
        - 先にバリデーションを行うことで、トランザクション内でのエラーハンドリングが容易にある
    - デメリット
        - バリデーション/投入で、それぞれ同じデータ数に対して、ループ処理が2重になる

- 不採用 : データ登録時に、都度 バリデーションを行う
    - メリット
        - 都度バリデーション、データ投入を行うため、1件ごとのエラーハンドリングが可能
        - 同じループ内で、バリデーション、データ投入を行えるため、処理を分離したときよりも処理時間は短くなると予想できる
    - デメリット
        - トランザクション管理が複雑になる可能性がある


# 問題点

- データの重複が存在する
    - 対応方針
        - pandasを利用して、重複を削除する。
            - 1つめのレコードを活かす
            - 2つめ以降のレコードを削除する

- 日時分が抜けている・欠損がある場合対応方針
    - 対応方針
        - pandasを利用して、欠損データの補完を行う
        - 使用量の補完は、1つ前のレコードのデータを用いてる
            - １つ目のデータを使用する理由は、連続使用の際に変動が少ないと見込めるため


# 質問事項

- Q. Python、Django ともに古いバージョンが指定されていますが、指定通りに利用してよろしいでしょうか？

    - A. 問題ないですが、バージョン上げていただいても構いません。

- Q. user_data.csv内のid、また consumption フォルダ内のファイル名の user_idは、0埋め4桁が必ず指定される想定してよろしいでしょうか？

    - A. 0埋めしない想定でお願いします。(id=100もあり得ます)

- Q. 3039.csv、3042.csv、3043.csv、3072.csv の行数が、8163行で、その他のファイルの行が8164行のように見受けられます。こちらについては、意図して行の差異がありますでしょうか？

    - A. はい、課題としては意図して作成しております。（少し意地悪ですが）減点ではなく、ボーナスポイントのようなイメージで差異に気付いていただけるかどうかも見ていました。今回気付いていただいたので、差異の原因を確認してどのように対処するのが良いかを検討して対応いただけると幸いです。

- Q. 仮に、user_data.csv内にidがあり、それに対応するconsumption内のcsvファイルがない場合、user_data内の該当行についても登録はDBへの登録を不要でしょうか？このケースは、ユーザとして登録はしているが過去消費がないと考えることも可能かと思います。

    - A. user_data.csvにあるidに対応するファイルがない場合は、DBへの登録は不要です。user_dataは登録をお願いします。

- Q. 上記に続き、consumption内のcsvファイルのuser_idに該当するidが、user_data.csvの中に存在しない場合、DBへの登録を不要でしょうか？このケースは、過去ユーザ登録していたが、退会時にuser_data.csvから削除されている可能性があります。consumption内の消費データはログとして残している可能性もありますが、user_data.csv内のエリア(area)、料金表(料金表)と紐づかないと、消費データの集計の実装(例：合計/平均)では使えるかと思いますが、エリア(area)、料金表(料金表)を加味した分析には使えないと考えます。

    - A. はい、紐付けられない場合は、consumptionのDBへの登録は不要です。

- Q. user_dataのエリア(area)については、user_data.csv内に記載されているエリアの値は、a1、a2 のうちいずれかの値のみと考えてよろしいでしょうか？質問の意図としては、エリアが増える可能性を考慮すると、user_data を格納するテーブルとは別に、エリアデータをマスタとしてもたせて、admin画面から随時追加できるようにしておくほうが便利と思ったからです。

    - A. user_data.csvにあるidに対応するファイルがない場合は、DBへの登録は不要です。user_dataは登録をお願いします。

- Q. user_dataの料金表(tariff)については、user_data.csv内に記載されている料金表の値は、t1、t2、t3 のうちいずれかの値のみと考えてよろしいでしょうか？質問の意図としては、料金プランが増える可能性を考慮すると、user_data を格納するテーブルとは別に、料金データをマスタとしてもたせて、admin画面から随時追加できるようにしておくほうが便利と思ったからです。

    - A. こちらも同様に、料金データを別のマスタテーブルとしても構いません。

- Q. consumption内のcsv データは、30分おきに記録されている認識ですが、一部欠損が確認できました。
こちらについては、なにかしらの不備でログに記録できなかったと判断してもよろしいでしょうか？

    - A. はい、そちらに関してはなにかしらの不備でログに記録できなかったものを想定しております。
対応しなくても減点にはなりませんが、余力があればどのように対応するのがよいか検討して対応いただけますと幸いです。
